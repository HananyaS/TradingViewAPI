<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trading Journal - Stock Screener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/trv_api_logo.svg">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .header p {
            margin: 1rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-container {
            padding: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        
        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        
        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .badge {
            border-radius: 20px;
            padding: 8px 12px;
            font-weight: 500;
        }
        
        .text-success {
            color: #28a745 !important;
        }
        
        .text-danger {
            color: #dc3545 !important;
        }
        
        .nav-tabs {
            border-bottom: 2px solid #e9ecef;
        }
        
        .nav-tabs .nav-link {
            border: none;
            border-radius: 10px 10px 0 0;
            color: #6c757d;
            font-weight: 500;
            padding: 12px 20px;
            margin-right: 5px;
        }
        
        .nav-tabs .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
        }
        
        .nav-tabs .nav-link:hover {
            border: none;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stats-card h3 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stats-card p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        /* TradingView link styling */
        .btn-outline-primary {
            border-color: #007bff;
            color: #007bff;
            background-color: transparent;
        }
        
        .btn-outline-primary:hover {
            background-color: #007bff;
            color: white;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
        }
        
        /* Clickable stock symbol styling */
        .stock-symbol-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .stock-symbol-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-book"></i> Trading Journal</h1>
                    <p>Document your trades and track your performance</p>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <a href="/" class="btn btn-outline-light">
                        <i class="fas fa-home"></i> Home
                    </a>
                    <a href="/watchlist" class="btn btn-outline-light">
                        <i class="fas fa-eye"></i> Watchlist
                    </a>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <!-- Trading Statistics -->
            <div class="row justify-content-center" id="statsRow">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="totalTrades">0</h3>
                        <p>Total Trades</p>
                    </div>
                </div>

                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="winRate">0%</h3>
                        <p>Win Rate</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="avgReturn">0%</h3>
                        <p>Avg Return</p>
                    </div>
                </div>
            </div>
            
            <!-- Debug Tools -->
            <div class="card mb-3">
                <div class="card-header">
                    <h5><i class="fas fa-bug"></i> Debug Tools</h5>
                </div>
                <div class="card-body">
                    <button type="button" class="btn btn-warning" onclick="testPriceUpdate()">
                        <i class="fas fa-sync"></i> Test Price Update
                    </button>
                    <button type="button" class="btn btn-info" onclick="checkTrades()">
                        <i class="fas fa-list"></i> Check Trades
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="checkElements()">
                        <i class="fas fa-search"></i> Check Elements
                    </button>
                </div>
            </div>
            
            <!-- Add Trade Form -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plus"></i> Add New Trade</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <label for="tradeSymbol" class="form-label">Symbol</label>
                            <input type="text" class="form-control" id="tradeSymbol" placeholder="e.g., AAPL">
                        </div>
                        <div class="col-md-6">
                            <label for="tradeType" class="form-label">Trade Type</label>
                            <select class="form-control" id="tradeType">
                                <option value="buy">Buy</option>
                                <option value="sell">Sell</option>
                                <option value="short">Short</option>
                                <option value="cover">Cover</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <label for="tradePrice" class="form-label">Price</label>
                            <input type="number" class="form-control" id="tradePrice" step="0.01" min="0">
                        </div>
                        <div class="col-md-4">
                            <label for="tradeQuantity" class="form-label">Quantity</label>
                            <input type="number" class="form-control" id="tradeQuantity" min="1">
                        </div>
                        <div class="col-md-4">
                            <label for="tradeDate" class="form-label">Date</label>
                            <input type="date" class="form-control" id="tradeDate">
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <label for="tradeNotes" class="form-label">Notes</label>
                            <textarea class="form-control" id="tradeNotes" rows="3" placeholder="Trade reasoning, strategy, lessons learned..."></textarea>
                        </div>
                        <div class="col-md-4">
                            <label for="tradeScreener" class="form-label">Link to Screener</label>
                            <select class="form-control" id="tradeScreener">
                                <option value="">No Screener</option>
                            </select>
                            <div class="form-text">Link this trade to a saved screener</div>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-primary" onclick="addTrade()">
                                <i class="fas fa-plus"></i> Add Trade
                            </button>
                            <button type="button" class="btn btn-secondary" onclick="clearTradeForm()">
                                <i class="fas fa-undo"></i> Clear Form
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Trade History -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-history"></i> Trade History</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <button class="btn btn-info" onclick="exportTrades()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="btn btn-danger" onclick="clearAllTrades()">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                    <div class="table-responsive">
                        <table class="table table-striped" id="tradesTable">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Symbol</th>
                                    <th>Type</th>
                                    <th>Trade Price</th>
                                    <th>Current Price</th>
                                    <th>Quantity</th>
                                    <th>Total</th>
                                    <th>Screener</th>
                                    <th>Notes</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="tradesTableBody">
                                <!-- Trades will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let trades = [];
        let currentUser = null;
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuth().then(() => {
                // Set default date to today
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('tradeDate').value = today;
                
                // Load trades and screeners
                loadTrades();
                loadScreeners();
                updateStats();
                
                // Start automatic price updates every 2 seconds
                startPriceUpdates();
            });
        });
        
        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const user = await response.json();
                
                if (user.authenticated === false) {
                    // Redirect to login if not authenticated
                    window.location.href = '/login';
                    return;
                }
                
                currentUser = user;
                console.log('User authenticated:', user.email);
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = '/login';
            }
        }
        
        // Add trade to journal
        async function addTrade() {
            const symbol = document.getElementById('tradeSymbol').value.trim().toUpperCase();
            const type = document.getElementById('tradeType').value;
            const price = parseFloat(document.getElementById('tradePrice').value);
            const quantity = parseInt(document.getElementById('tradeQuantity').value);
            const date = document.getElementById('tradeDate').value;
            const notes = document.getElementById('tradeNotes').value.trim();
            
            if (!symbol || !price || !quantity || !date) {
                alert('Please fill in all required fields (Symbol, Price, Quantity, Date)');
                return;
            }
            
            const screenerId = document.getElementById('tradeScreener').value;
            
            const tradeData = {
                symbol: symbol,
                type: type,
                price: price,
                quantity: quantity,
                date: date,
                notes: notes,
                screenerId: screenerId || null
            };
            
            try {
                const response = await fetch('/api/journal/trades', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(tradeData)
                });
                
                if (!response.ok) {
                    const status = response.status || 'unknown';
                    const statusText = response.statusText || 'unknown error';
                    console.error(`Error saving trade: HTTP ${status} - ${statusText}`);
                    alert(`❌ Error saving trade: HTTP ${status}`);
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    // Clear form
                    clearTradeForm();
                    
                    // Reload trades and stats
                    await loadTrades();
                    updateStats();
                    
                    alert(`✅ Trade added successfully!\n\n📊 ${symbol} ${type.toUpperCase()} ${quantity} shares @ $${price}\n\n📅 Date: ${date}`);
                } else {
                    alert(`❌ Error saving trade: ${result.error}`);
                }
            } catch (error) {
                console.error('Error saving trade:', error);
                alert('❌ Error saving trade. Please try again.');
            }
        }
        
        // Load screeners into dropdown
        async function loadScreeners() {
            try {
                const response = await fetch('/api/screeners');
                const result = await response.json();
                
                const screenerSelect = document.getElementById('tradeScreener');
                screenerSelect.innerHTML = '<option value="">No Screener</option>';
                
                if (result.success && result.screeners) {
                    result.screeners.forEach(screener => {
                        const option = document.createElement('option');
                        option.value = screener._id;
                        option.textContent = screener.name;
                        screenerSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading screeners:', error);
            }
        }
        
        // Clear trade form
        function clearTradeForm() {
            document.getElementById('tradeSymbol').value = '';
            document.getElementById('tradePrice').value = '';
            document.getElementById('tradeQuantity').value = '';
            document.getElementById('tradeNotes').value = '';
            document.getElementById('tradeDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('tradeScreener').value = '';
        }
        
        // Load trades into table
        async function loadTrades() {
            try {
                const response = await fetch('/api/journal/trades');
                
                if (!response.ok) {
                    const status = response.status || 'unknown';
                    const statusText = response.statusText || 'unknown error';
                    console.error(`Error loading trades: HTTP ${status} - ${statusText}`);
                    trades = [];
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    trades = result.trades || [];
                } else {
                    console.error('Error loading trades:', result.error);
                    trades = [];
                }
            } catch (error) {
                console.error('Error loading trades:', error);
                trades = [];
            }
            
            const tbody = document.getElementById('tradesTableBody');
            tbody.innerHTML = '';
            
            if (trades.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="text-center text-muted">No trades recorded yet. Add your first trade!</td></tr>';
                return;
            }
            
            // Sort trades by date (newest first)
            const sortedTrades = trades.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedTrades.forEach(trade => {
                const total = (trade.price * trade.quantity).toFixed(2);
                const typeClass = trade.type === 'buy' || trade.type === 'cover' ? 'text-success' : 'text-danger';
                const typeIcon = trade.type === 'buy' ? '📈' : trade.type === 'sell' ? '📉' : trade.type === 'short' ? '🔻' : '🔺';
                
                const screenerDisplay = trade.screenerId ? `<span class="badge bg-info">Linked</span>` : '-';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${trade.date}</td>
                    <td>
                        <a href="https://www.tradingview.com/symbols/${trade.symbol}" target="_blank" class="stock-symbol-link">
                            <strong>${trade.symbol}</strong>
                        </a>
                        <a href="https://www.tradingview.com/symbols/${trade.symbol}" target="_blank" class="btn btn-sm btn-outline-primary ms-2" title="View on TradingView">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </td>
                    <td><span class="${typeClass}">${typeIcon} ${trade.type.toUpperCase()}</span></td>
                    <td>$${trade.price}</td>
                    <td id="current-price-${trade.symbol}">Loading...</td>
                    <td>${trade.quantity}</td>
                    <td>$${total}</td>
                    <td>${screenerDisplay}</td>
                    <td>${trade.notes || '-'}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="deleteTrade('${trade._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Fetch current prices for all unique symbols
            updateCurrentPrices();
            
            // If there are trades, start immediate price updates
            if (trades.length > 0) {
                console.log('Initial price update for journal trades...');
                updateCurrentPrices();
            }
        }
        
        // Start automatic price updates
        function startPriceUpdates() {
            console.log('Starting automatic price updates for journal...');
            console.log('Initial trades count:', trades.length);
            
            // Update prices every 2 seconds
            const intervalId = setInterval(() => {
                console.log('Auto-update interval triggered, trades count:', trades.length);
                if (trades.length > 0) {
                    console.log('Auto-updating prices for journal trades...');
                    updateCurrentPrices();
                } else {
                    console.log('No trades to update, skipping...');
                }
            }, 2000);
            
            console.log('Price update interval started with ID:', intervalId);
        }
        
        // Update current prices for all trades
        async function updateCurrentPrices() {
            console.log('Starting updateCurrentPrices...');
            console.log('Current trades:', trades);
            
            // Get unique symbols from trades
            const uniqueSymbols = [...new Set(trades.map(trade => trade.symbol))];
            console.log('Unique symbols to update:', uniqueSymbols);
            
            if (uniqueSymbols.length === 0) {
                console.log('No symbols to update');
                return;
            }
            
            try {
                // Get cached prices from MongoDB (updated by background thread)
                console.log('Fetching cached prices from MongoDB...');
                const cacheResponse = await fetch(`/api/prices/cache?${uniqueSymbols.map(s => `symbols[]=${s}`).join('&')}`);
                const cacheData = await cacheResponse.json();
                
                if (cacheData.success && cacheData.prices) {
                    console.log('Got cached prices:', cacheData.prices);
                    
                    // Update UI with cached prices
                    for (const symbol of uniqueSymbols) {
                        const price = cacheData.prices[symbol];
                        if (price) {
                            // Update all price elements for this symbol
                            const priceElements = document.querySelectorAll(`#current-price-${symbol}`);
                            console.log(`Found ${priceElements.length} price elements for ${symbol}`);
                            
                            priceElements.forEach((element, index) => {
                                try {
                                    const currentPrice = price.current;
                                    const tradeRow = element.closest('tr');
                                    const tradePriceElement = tradeRow.querySelector('td:nth-child(4)');
                                    
                                    if (!tradePriceElement) {
                                        console.warn(`Could not find trade price element for ${symbol}`);
                                        return;
                                    }
                                    
                                    const tradePrice = parseFloat(tradePriceElement.textContent.replace('$', ''));
                                    const priceChange = currentPrice - tradePrice;
                                    const priceChangePercent = ((priceChange / tradePrice) * 100);
                                    
                                    let changeClass = '';
                                    let changeIcon = '';
                                    if (priceChange > 0) {
                                        changeClass = 'text-success';
                                        changeIcon = '📈';
                                    } else if (priceChange < 0) {
                                        changeClass = 'text-danger';
                                        changeIcon = '📉';
                                    }
                                    
                                    element.innerHTML = `
                                        <div class="${changeClass}">
                                            <strong>$${currentPrice.toFixed(2)}</strong>
                                            <br><small>${changeIcon} ${priceChangePercent.toFixed(2)}%</small>
                                        </div>
                                    `;
                                    
                                    console.log(`Updated price for ${symbol} element ${index + 1}: $${currentPrice} (${priceChangePercent.toFixed(2)}%)`);
                                } catch (elementError) {
                                    console.error(`Error updating element for ${symbol}:`, elementError);
                                }
                            });
                        } else {
                            console.warn(`No cached price data available for ${symbol}`);
                            // Show no data state
                            const priceElements = document.querySelectorAll(`#current-price-${symbol}`);
                            priceElements.forEach(element => {
                                element.innerHTML = '<span class="text-muted">No data</span>';
                            });
                        }
                    }
                } else {
                    console.warn('No cached prices available, showing no data');
                    // Show no data for all symbols
                    for (const symbol of uniqueSymbols) {
                        const priceElements = document.querySelectorAll(`#current-price-${symbol}`);
                        priceElements.forEach(element => {
                            element.innerHTML = '<span class="text-muted">No data</span>';
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error updating prices from cache:', error);
                // Show error state for all symbols
                for (const symbol of uniqueSymbols) {
                    const priceElements = document.querySelectorAll(`#current-price-${symbol}`);
                    priceElements.forEach(element => {
                        element.innerHTML = '<span class="text-muted">Error</span>';
                    });
                }
            }
            
            console.log('Finished updateCurrentPrices');
        }
        
        // Fetch stock price using TradingView Screener API
        async function fetchStockPrice(symbol) {
            try {
                console.log(`Fetching price for ${symbol} using TradingView screener...`);
                
                const response = await fetch('https://scanner.tradingview.com/america/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'Accept-Encoding': 'gzip, deflate, br',
                        'Connection': 'keep-alive',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify({
                        "symbols": {
                            "tickers": [`NASDAQ:${symbol}`, `NYSE:${symbol}`, `AMEX:${symbol}`]
                        },
                        "columns": [
                            "price",
                            "change",
                            "change_abs",
                            "volume"
                        ],
                        "range": [0, 1]
                    })
                });

                if (!response.ok) {
                    const status = response.status || 'unknown';
                    const statusText = response.statusText || 'unknown error';
                    console.error(`TradingView API error for ${symbol}: HTTP ${status} - ${statusText}`);
                    return null;
                }

                const data = await response.json();
                console.log(`TradingView response for ${symbol}:`, data);

                if (data.data && data.data.length > 0) {
                    const stockData = data.data[0];
                    const current = parseFloat(stockData.d[0]); // price
                    const change = parseFloat(stockData.d[1]); // change
                    const changePercent = parseFloat(stockData.d[2]); // change_abs

                    console.log(`Successfully fetched price for ${symbol}: $${current} (${changePercent}%)`);

                    return {
                        current: current,
                        change: change,
                        changePercent: changePercent
                    };
                } else {
                    console.error(`No data found for ${symbol} in TradingView response`);
                    console.error(`Response data:`, data);
                    return null;
                }
            } catch (error) {
                console.error(`Error fetching price for ${symbol}:`, error);
                console.error(`Error details:`, {
                    message: error.message,
                    stack: error.stack,
                    symbol: symbol
                });
                return null;
            }
        }
        

        
        // Delete trade
        async function deleteTrade(tradeId) {
            if (confirm('Are you sure you want to delete this trade?')) {
                try {
                    const response = await fetch(`/api/journal/trades/${tradeId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const status = response.status || 'unknown';
                        const statusText = response.statusText || 'unknown error';
                        console.error(`Error deleting trade: HTTP ${status} - ${statusText}`);
                        alert(`❌ Error deleting trade: HTTP ${status}`);
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        await loadTrades();
                        updateStats();
                    } else {
                        alert(`❌ Error deleting trade: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error deleting trade:', error);
                    alert('❌ Error deleting trade. Please try again.');
                }
            }
        }
        
        // Clear all trades
        async function clearAllTrades() {
            if (confirm('Are you sure you want to delete ALL trades? This action cannot be undone.')) {
                try {
                    // Delete all trades one by one
                    for (const trade of trades) {
                        const response = await fetch(`/api/journal/trades/${trade._id}`, {
                            method: 'DELETE'
                        });
                        
                        const result = await response.json();
                        if (!result.success) {
                            console.error(`Error deleting trade ${trade._id}:`, result.error);
                        }
                    }
                    
                    await loadTrades();
                    updateStats();
                    alert('✅ All trades cleared successfully!');
                } catch (error) {
                    console.error('Error clearing trades:', error);
                    alert('❌ Error clearing trades. Please try again.');
                }
            }
        }
        
        // Update statistics
        function updateStats() {
            const totalTrades = trades.length;
            
            // Calculate win rate based on completed trades (buys followed by sells)
            const completedTrades = calculateCompletedTrades();
            const winRate = completedTrades.total > 0 ? ((completedTrades.wins / completedTrades.total) * 100).toFixed(1) : 0;
            
            // Calculate average return per trade
            const avgReturn = completedTrades.total > 0 ? (completedTrades.totalReturn / completedTrades.total).toFixed(2) : 0;
            
            document.getElementById('totalTrades').textContent = totalTrades;
            document.getElementById('winRate').textContent = `${winRate}%`;
            document.getElementById('avgReturn').textContent = `${avgReturn}%`;
        }
        
        // Calculate completed trades and returns
        function calculateCompletedTrades() {
            const tradesBySymbol = {};
            
            // Group trades by symbol
            trades.forEach(trade => {
                if (!tradesBySymbol[trade.symbol]) {
                    tradesBySymbol[trade.symbol] = [];
                }
                tradesBySymbol[trade.symbol].push(trade);
            });
            
            let totalCompleted = 0;
            let totalWins = 0;
            let totalReturn = 0;
            
            // Calculate returns for each symbol
            Object.values(tradesBySymbol).forEach(symbolTrades => {
                // Sort by date
                symbolTrades.sort((a, b) => new Date(a.date) - new Date(b.date));
                
                let position = 0;
                let avgBuyPrice = 0;
                let totalQuantity = 0;
                
                symbolTrades.forEach(trade => {
                    if (trade.type === 'buy') {
                        // Add to position
                        const newQuantity = totalQuantity + trade.quantity;
                        avgBuyPrice = ((avgBuyPrice * totalQuantity) + (trade.price * trade.quantity)) / newQuantity;
                        totalQuantity = newQuantity;
                        position += trade.quantity * trade.price;
                    } else if (trade.type === 'sell' && totalQuantity > 0) {
                        // Calculate profit/loss
                        const sellQuantity = Math.min(trade.quantity, totalQuantity);
                        const sellValue = sellQuantity * trade.price;
                        const buyValue = sellQuantity * avgBuyPrice;
                        const profit = sellValue - buyValue;
                        const returnPercent = (profit / buyValue) * 100;
                        
                        totalReturn += returnPercent;
                        totalCompleted++;
                        
                        if (profit > 0) {
                            totalWins++;
                        }
                        
                        // Update position
                        totalQuantity -= sellQuantity;
                        if (totalQuantity === 0) {
                            avgBuyPrice = 0;
                        }
                    }
                });
            });
            
            return {
                total: totalCompleted,
                wins: totalWins,
                totalReturn: totalReturn
            };
        }
        
        // Export trades to CSV
        function exportTrades() {
            if (trades.length === 0) {
                alert('No trades to export');
                return;
            }
            
            const headers = ['Date', 'Symbol', 'Type', 'Price', 'Quantity', 'Total', 'Notes'];
            const csvContent = [
                headers.join(','),
                ...trades.map(trade => [
                    trade.date,
                    trade.symbol,
                    trade.type,
                    trade.price,
                    trade.quantity,
                    (trade.price * trade.quantity).toFixed(2),
                    `"${trade.notes || ''}"`
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `trading_journal_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('✅ Trading journal exported successfully!');
        }
        
        // Debug functions
        function testPriceUpdate() {
            console.log('=== TESTING PRICE UPDATE ===');
            console.log('Trades count:', trades.length);
            console.log('Trades:', trades);
            updateCurrentPrices();
        }
        
        function checkTrades() {
            console.log('=== CHECKING TRADES ===');
            console.log('Trades from localStorage:', JSON.parse(localStorage.getItem(getTradesKey()) || '[]'));
            console.log('Current trades array:', trades);
            console.log('Unique symbols:', [...new Set(trades.map(trade => trade.symbol))]);
        }
        
        function checkElements() {
            console.log('=== CHECKING ELEMENTS ===');
            const symbols = [...new Set(trades.map(trade => trade.symbol))];
            symbols.forEach(symbol => {
                const elements = document.querySelectorAll(`#current-price-${symbol}`);
                console.log(`Elements for ${symbol}:`, elements.length);
                elements.forEach((el, index) => {
                    console.log(`  Element ${index + 1}:`, el);
                });
            });
        }
    </script>
</body>
</html> 