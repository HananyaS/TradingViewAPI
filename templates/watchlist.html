<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Watchlist - Stock Screener</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link rel="icon" type="image/svg+xml" href="/trv_api_logo.svg">
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .main-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            margin: 2rem auto;
            max-width: 1200px;
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            text-align: center;
        }
        
        .header h1 {
            margin: 0;
            font-size: 2.5rem;
            font-weight: 700;
        }
        
        .header p {
            margin: 1rem 0 0 0;
            opacity: 0.9;
            font-size: 1.1rem;
        }
        
        .form-container {
            padding: 2rem;
        }
        
        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
            margin-bottom: 1.5rem;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px 15px 0 0 !important;
            padding: 1rem 1.5rem;
        }
        
        .card-header h5 {
            margin: 0;
            font-weight: 600;
        }
        
        .btn {
            border-radius: 10px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            padding: 12px 15px;
            transition: all 0.3s ease;
        }
        
        .form-control:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 0.2rem rgba(102, 126, 234, 0.25);
        }
        
        .form-label {
            font-weight: 600;
            color: #495057;
            margin-bottom: 0.5rem;
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
        }
        
        .table th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            font-weight: 600;
        }
        
        .badge {
            border-radius: 20px;
            padding: 8px 12px;
            font-weight: 500;
        }
        
        .text-success {
            color: #28a745 !important;
        }
        
        .text-danger {
            color: #dc3545 !important;
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .stats-card h3 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }
        
        .stats-card p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }
        
        .category-filter {
            margin-bottom: 1rem;
        }
        
        .category-filter .btn {
            margin-right: 0.5rem;
            margin-bottom: 0.5rem;
        }
        
        .category-filter .btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-color: #667eea;
        }
        
        /* TradingView link styling */
        .btn-outline-primary {
            border-color: #007bff;
            color: #007bff;
            background-color: transparent;
        }
        
        .btn-outline-primary:hover {
            background-color: #007bff;
            color: white;
        }
        
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
        }
        
        /* Clickable stock symbol styling */
        .stock-symbol-link {
            color: #007bff;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .stock-symbol-link:hover {
            color: #0056b3;
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="main-container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h1><i class="fas fa-eye"></i> Dynamic Watchlist</h1>
                    <p>Track your favorite stocks and monitor their performance</p>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <a href="/" class="btn btn-outline-light">
                        <i class="fas fa-home"></i> Home
                    </a>
                    <a href="/journal" class="btn btn-outline-light">
                        <i class="fas fa-book"></i> Journal
                    </a>
                </div>
            </div>
        </div>
        
        <div class="form-container">
            <!-- Watchlist Statistics -->
            <div class="row" id="statsRow">
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="totalSymbols">0</h3>
                        <p>Total Symbols</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="activeSymbols">0</h3>
                        <p>Active</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="potentialSymbols">0</h3>
                        <p>Potential</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card text-center">
                        <h3 id="holdingsSymbols">0</h3>
                        <p>Holdings</p>
                    </div>
                </div>
            </div>
            
            <!-- Add to Watchlist -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-plus"></i> Add to Watchlist</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <label for="watchlistSymbol" class="form-label">Symbols</label>
                            <input type="text" class="form-control" id="watchlistSymbol" placeholder="e.g., AAPL, TSLA, GOOGL">
                            <div class="form-text">Enter multiple symbols separated by commas</div>
                        </div>
                        <div class="col-md-4">
                            <label for="watchlistCategory" class="form-label">Category</label>
                            <select class="form-control" id="watchlistCategory">
                                <option value="active">Active</option>
                                <option value="potential">Potential</option>
                                <option value="holdings">Holdings</option>
                                <option value="sold">Sold</option>
                            </select>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-12">
                            <button type="button" class="btn btn-success" onclick="addToWatchlist()">
                                <i class="fas fa-plus"></i> Add to Watchlist
                            </button>
                            <div class="form-check form-switch d-inline-block ms-3">
                                <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
                                <label class="form-check-label" for="autoRefreshToggle">
                                    <i class="fas fa-sync"></i> Auto-refresh prices
                                </label>
                                <small class="text-muted d-block">Updates every 2 seconds</small>
                                <div id="updateStatus" class="text-success small" style="display: none;">
                                    <i class="fas fa-circle"></i> Live updates active
                                </div>
                            </div>
                            <button type="button" class="btn btn-info" onclick="exportWatchlist()">
                                <i class="fas fa-download"></i> Export CSV
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Watchlist Categories Explanation -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5><i class="fas fa-info-circle"></i> Watchlist Categories Guide</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><span class="badge bg-primary">Active</span> - Currently Trading</h6>
                            <p class="text-muted small">Stocks you're actively trading or monitoring for immediate opportunities. These are your primary focus stocks with high potential for short-term moves.</p>
                            
                            <h6><span class="badge bg-warning">Potential</span> - Watch & Wait</h6>
                            <p class="text-muted small">Stocks showing promising patterns or setups that you're watching for entry signals. These are candidates for future trades.</p>
                        </div>
                        <div class="col-md-6">
                            <h6><span class="badge bg-success">Holdings</span> - Long-term Positions</h6>
                            <p class="text-muted small">Stocks you currently own and are holding for longer-term gains. These are your investment positions.</p>
                            
                            <h6><span class="badge bg-secondary">Sold</span> - Recently Exited</h6>
                            <p class="text-muted small">Stocks you recently sold but want to monitor for potential re-entry or to track their post-exit performance.</p>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <h6><i class="fas fa-lightbulb"></i> How to Use Categories:</h6>
                        <ul class="small text-muted">
                            <li><strong>Active:</strong> Focus your daily analysis on these stocks</li>
                            <li><strong>Potential:</strong> Review weekly for new opportunities</li>
                            <li><strong>Holdings:</strong> Monitor for exit signals or position adjustments</li>
                            <li><strong>Sold:</strong> Track for learning and potential re-entry</li>
                        </ul>
                    </div>
                </div>
            </div>
            
            <!-- Watchlist Table -->
            <div class="card">
                <div class="card-header">
                    <h5><i class="fas fa-list"></i> Your Watchlist</h5>
                </div>
                <div class="card-body">
                    <!-- Category Filter -->
                    <div class="category-filter">
                        <button class="btn btn-outline-primary active" onclick="filterByCategory('all')">All</button>
                        <button class="btn btn-outline-primary" onclick="filterByCategory('active')">Active</button>
                        <button class="btn btn-outline-warning" onclick="filterByCategory('potential')">Potential</button>
                        <button class="btn btn-outline-success" onclick="filterByCategory('holdings')">Holdings</button>
                        <button class="btn btn-outline-secondary" onclick="filterByCategory('sold')">Sold</button>
                    </div>
                    
                    <div class="table-responsive">
                        <table class="table table-striped" id="watchlistTable">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Category</th>
                                    <th>Current Price</th>
                                    <th>Change</th>
                                    <th>Change %</th>
                                    <th>Added Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="watchlistTableBody">
                                <!-- Watchlist items will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let watchlist = [];
        let currentUser = null;
        let currentFilter = 'all';
        
        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            // Check authentication first
            checkAuth().then(() => {
                // Load watchlist
                loadWatchlist();
                
                // Immediately update prices when page loads
                if (watchlist.length > 0) {
                    console.log('Initial price update for watchlist...');
                    refreshWatchlist();
                }
                
                // Start automatic price updates every 2 seconds
                startPriceUpdates();
            });
        });
        
        // Check authentication
        async function checkAuth() {
            try {
                const response = await fetch('/api/user');
                const user = await response.json();
                
                if (user.authenticated === false) {
                    // Redirect to login if not authenticated
                    window.location.href = '/login';
                    return;
                }
                
                currentUser = user;
                console.log('User authenticated:', user.email);
            } catch (error) {
                console.error('Error checking auth:', error);
                window.location.href = '/login';
            }
        }
        
        // Add to watchlist
        async function addToWatchlist() {
            const symbolsInput = document.getElementById('watchlistSymbol').value.trim();
            const category = document.getElementById('watchlistCategory').value;
            
            if (!symbolsInput) {
                alert('Please enter at least one symbol');
                return;
            }
            
            const symbols = symbolsInput.split(',').map(s => s.trim().toUpperCase()).filter(s => s);
            
                            try {
                    // Add each symbol to MongoDB
                    for (const symbol of symbols) {
                        const itemData = {
                            symbol: symbol,
                            category: category,
                            notes: '',
                            target_price: null,
                            stop_loss: null
                        };
                        
                        const response = await fetch('/api/watchlist/items', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(itemData)
                        });
                        
                        if (!response.ok) {
                            const status = response.status || 'unknown';
                            const statusText = response.statusText || 'unknown error';
                            console.error(`Error adding ${symbol}: HTTP ${status} - ${statusText}`);
                            continue;
                        }
                        
                        const result = await response.json();
                        if (!result.success) {
                            console.error(`Error adding ${symbol}:`, result.error);
                        }
                    }
                
                // Clear input
                document.getElementById('watchlistSymbol').value = '';
                
                // Reload watchlist and stats
                await loadWatchlist();
                updateStats();
                
                alert(`✅ Added ${symbols.length} symbol(s) to ${category} watchlist!\n\n📊 Symbols: ${symbols.join(', ')}`);
            } catch (error) {
                console.error('Error adding to watchlist:', error);
                alert('❌ Error adding to watchlist. Please try again.');
            }
        }
        
        // Load watchlist into table
        async function loadWatchlist() {
            try {
                const response = await fetch('/api/watchlist/items');
                
                if (!response.ok) {
                    const status = response.status || 'unknown';
                    const statusText = response.statusText || 'unknown error';
                    console.error(`Error loading watchlist: HTTP ${status} - ${statusText}`);
                    watchlist = [];
                    return;
                }
                
                const result = await response.json();
                
                if (result.success) {
                    watchlist = result.items || [];
                } else {
                    console.error('Error loading watchlist:', result.error);
                    watchlist = [];
                }
            } catch (error) {
                console.error('Error loading watchlist:', error);
                watchlist = [];
            }
            
            const tbody = document.getElementById('watchlistTableBody');
            tbody.innerHTML = '';
            
            if (watchlist.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Your watchlist is empty. Add some symbols first!</td></tr>';
                return;
            }
            
            // Filter watchlist based on current filter
            let filteredWatchlist = watchlist;
            if (currentFilter !== 'all') {
                filteredWatchlist = watchlist.filter(item => item.category === currentFilter);
            }
            
            if (filteredWatchlist.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">No symbols in ${currentFilter} category</td></tr>`;
                return;
            }
            
            // Sort by symbol
            filteredWatchlist.sort((a, b) => a.symbol.localeCompare(b.symbol));
            
            filteredWatchlist.forEach(item => {
                const categoryBadge = `<span class="badge bg-${getCategoryColor(item.category)}">${item.category}</span>`;
                const priceDisplay = item.currentPrice ? `$${item.currentPrice}` : 'Loading...';
                const changeDisplay = item.priceChange ? `$${item.priceChange}` : '-';
                const changePercentDisplay = item.priceChangePercent ? `${item.priceChangePercent}%` : '-';
                const changeClass = item.priceChangePercent > 0 ? 'text-success' : item.priceChangePercent < 0 ? 'text-danger' : '';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <a href="https://www.tradingview.com/symbols/${item.symbol}" target="_blank" class="stock-symbol-link">
                            <strong>${item.symbol}</strong>
                        </a>
                        <a href="https://www.tradingview.com/symbols/${item.symbol}" target="_blank" class="btn btn-sm btn-outline-primary ms-2" title="View on TradingView">
                            <i class="fas fa-external-link-alt"></i>
                        </a>
                    </td>
                    <td>${categoryBadge}</td>
                    <td>${priceDisplay}</td>
                    <td class="${changeClass}">${changeDisplay}</td>
                    <td class="${changeClass}">${changePercentDisplay}</td>
                    <td>${new Date(item.created_at).toLocaleDateString()}</td>
                    <td>
                        <button class="btn btn-sm btn-danger" onclick="removeFromWatchlist('${item._id}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        // Filter by category
        function filterByCategory(category) {
            currentFilter = category;
            
            // Update active button
            document.querySelectorAll('.category-filter .btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            loadWatchlist();
        }
        
        // Get category color
        function getCategoryColor(category) {
            switch(category) {
                case 'active': return 'primary';
                case 'potential': return 'warning';
                case 'holdings': return 'success';
                case 'sold': return 'secondary';
                default: return 'info';
            }
        }
        
        // Remove from watchlist
        async function removeFromWatchlist(itemId) {
            const item = watchlist.find(item => item._id === itemId);
            if (!item) {
                console.error('Item not found:', itemId);
                return;
            }
            
            if (confirm(`Are you sure you want to remove ${item.symbol} from your watchlist?`)) {
                try {
                    const response = await fetch(`/api/watchlist/items/${itemId}`, {
                        method: 'DELETE'
                    });
                    
                    if (!response.ok) {
                        const status = response.status || 'unknown';
                        const statusText = response.statusText || 'unknown error';
                        console.error(`Error removing item: HTTP ${status} - ${statusText}`);
                        alert(`❌ Error removing item: HTTP ${status}`);
                        return;
                    }
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        await loadWatchlist();
                        updateStats();
                    } else {
                        alert(`❌ Error removing item: ${result.error}`);
                    }
                } catch (error) {
                    console.error('Error removing from watchlist:', error);
                    alert('❌ Error removing from watchlist. Please try again.');
                }
            }
        }
        
        // Update watchlist statistics
        function updateStats() {
            const totalItems = watchlist.length;
            const activeItems = watchlist.filter(item => item.category === 'active').length;
            const potentialItems = watchlist.filter(item => item.category === 'potential').length;
            const holdingsItems = watchlist.filter(item => item.category === 'holdings').length;
            const soldItems = watchlist.filter(item => item.category === 'sold').length;
            
            // Update stats if elements exist
            const totalEl = document.getElementById('totalItems');
            const activeEl = document.getElementById('activeItems');
            const potentialEl = document.getElementById('potentialItems');
            const holdingsEl = document.getElementById('holdingsItems');
            const soldEl = document.getElementById('soldItems');
            
            if (totalEl) totalEl.textContent = totalItems;
            if (activeEl) activeEl.textContent = activeItems;
            if (potentialEl) potentialEl.textContent = potentialItems;
            if (holdingsEl) holdingsEl.textContent = holdingsItems;
            if (soldEl) soldEl.textContent = soldItems;
        }
        
        // Start automatic price updates
        function startPriceUpdates() {
            console.log('Starting automatic price updates for watchlist...');
            console.log('Initial watchlist count:', watchlist.length);
            
            // Update prices every 2 seconds
            const intervalId = setInterval(() => {
                const autoRefreshToggle = document.getElementById('autoRefreshToggle');
                console.log('Auto-update interval triggered, watchlist count:', watchlist.length);
                console.log('Auto-refresh toggle checked:', autoRefreshToggle ? autoRefreshToggle.checked : 'toggle not found');
                
                if (autoRefreshToggle && autoRefreshToggle.checked && watchlist.length > 0) {
                    console.log('Auto-updating watchlist prices...');
                    refreshWatchlist();
                } else {
                    console.log('Skipping update - toggle off or no items');
                }
            }, 2000);
            
            console.log('Price update interval started with ID:', intervalId);
        }
        
        // Refresh watchlist prices
        async function refreshWatchlist() {
            console.log('Starting refreshWatchlist...');
            console.log('Current watchlist:', watchlist);
            
            if (watchlist.length === 0) {
                console.log('No watchlist items to update');
                return; // Silent return for auto-refresh
            }
            
            try {
                // Show update status
                const updateStatus = document.getElementById('updateStatus');
                if (updateStatus) {
                    updateStatus.style.display = 'block';
                    updateStatus.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Updating...';
                }
                
                // Get unique symbols
                const symbols = [...new Set(watchlist.map(item => item.symbol))];
                console.log('Unique symbols to update:', symbols);
                
                // Get cached prices from MongoDB (updated by background thread)
                console.log('Fetching cached prices from MongoDB...');
                const cacheResponse = await fetch(`/api/prices/cache?${symbols.map(s => `symbols[]=${s}`).join('&')}`);
                const cacheData = await cacheResponse.json();
                
                if (cacheData.success && cacheData.prices) {
                    console.log('Got cached prices:', cacheData.prices);
                    
                    // Update watchlist with cached prices
                    let totalUpdated = 0;
                    for (const symbol of symbols) {
                        const price = cacheData.prices[symbol];
                        if (price) {
                            console.log(`Got price for ${symbol}: $${price.current}`);
                            // Update all items with this symbol
                            let updatedCount = 0;
                            watchlist.forEach(item => {
                                if (item.symbol === symbol) {
                                    item.currentPrice = price.current;
                                    item.priceChange = price.change;
                                    item.priceChangePercent = price.changePercent;
                                    
                                    // Add timestamp for last update
                                    item.lastUpdate = new Date().toISOString();
                                    updatedCount++;
                                }
                            });
                            totalUpdated += updatedCount;
                            console.log(`Updated ${updatedCount} watchlist items for ${symbol}`);
                        } else {
                            console.warn(`No cached price data available for ${symbol}`);
                        }
                    }
                    
                    // Save updated watchlist
                    localStorage.setItem(getWatchlistKey(), JSON.stringify(watchlist));
                    console.log(`Saved updated watchlist to localStorage (${totalUpdated} items updated)`);
                    
                    // Reload display
                    loadWatchlist();
                    updateStats();
                    
                    // Update status
                    if (updateStatus) {
                        updateStatus.innerHTML = '<i class="fas fa-circle"></i> Live updates active';
                        setTimeout(() => {
                            updateStatus.style.display = 'none';
                        }, 2000);
                    }
                    
                    console.log('Finished refreshWatchlist');
                    
                } else {
                    console.warn('No cached prices available');
                    // Show no data for all symbols
                    for (const symbol of symbols) {
                        watchlist.forEach(item => {
                            if (item.symbol === symbol) {
                                item.currentPrice = null;
                                item.priceChange = null;
                                item.priceChangePercent = null;
                            }
                        });
                    }
                    
                    // Save updated watchlist
                    localStorage.setItem(getWatchlistKey(), JSON.stringify(watchlist));
                    
                    // Reload display
                    loadWatchlist();
                    updateStats();
                    
                    // Show error status
                    if (updateStatus) {
                        updateStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> No data available';
                        updateStatus.className = 'text-warning small';
                        setTimeout(() => {
                            updateStatus.style.display = 'none';
                            updateStatus.className = 'text-success small';
                        }, 3000);
                    }
                }
                
            } catch (error) {
                console.error('Error refreshing watchlist from cache:', error);
                // Show error status
                const updateStatus = document.getElementById('updateStatus');
                if (updateStatus) {
                    updateStatus.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Update failed';
                    updateStatus.className = 'text-danger small';
                    setTimeout(() => {
                        updateStatus.style.display = 'none';
                        updateStatus.className = 'text-success small';
                    }, 3000);
                }
            }
        }
        
        // Fetch stock price using TradingView Screener API
        async function fetchStockPrice(symbol) {
            try {
                console.log(`Fetching price for ${symbol} using TradingView screener...`);
                
                const response = await fetch('https://scanner.tradingview.com/america/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                        'Accept': 'application/json, text/plain, */*',
                        'Accept-Language': 'en-US,en;q=0.9',
                        'Accept-Encoding': 'gzip, deflate, br',
                        'Connection': 'keep-alive',
                        'Cache-Control': 'no-cache',
                        'Pragma': 'no-cache'
                    },
                    body: JSON.stringify({
                        "symbols": {
                            "tickers": [`NASDAQ:${symbol}`, `NYSE:${symbol}`, `AMEX:${symbol}`]
                        },
                        "columns": [
                            "price",
                            "change",
                            "change_abs",
                            "volume"
                        ],
                        "range": [0, 1]
                    })
                });

                if (!response.ok) {
                    const status = response.status || 'unknown';
                    const statusText = response.statusText || 'unknown error';
                    console.error(`TradingView API error for ${symbol}: HTTP ${status} - ${statusText}`);
                    return null;
                }

                const data = await response.json();
                console.log(`TradingView response for ${symbol}:`, data);

                if (data.data && data.data.length > 0) {
                    const stockData = data.data[0];
                    const current = parseFloat(stockData.d[0]); // price
                    const change = parseFloat(stockData.d[1]); // change
                    const changePercent = parseFloat(stockData.d[2]); // change_abs

                    console.log(`Successfully fetched price for ${symbol}: $${current} (${changePercent}%)`);

                    return {
                        current: current,
                        change: change,
                        changePercent: changePercent.toFixed(2)
                    };
                } else {
                    console.error(`No data found for ${symbol} in TradingView response`);
                    console.error(`Response data:`, data);
                    return null;
                }
            } catch (error) {
                console.error(`Error fetching price for ${symbol}:`, error);
                console.error(`Error details:`, {
                    message: error.message,
                    stack: error.stack,
                    symbol: symbol
                });
                return null;
            }
        }
        

        
        // Update statistics
        function updateStats() {
            const totalSymbols = watchlist.length;
            const activeSymbols = watchlist.filter(item => item.category === 'active').length;
            const potentialSymbols = watchlist.filter(item => item.category === 'potential').length;
            const holdingsSymbols = watchlist.filter(item => item.category === 'holdings').length;
            
            document.getElementById('totalSymbols').textContent = totalSymbols;
            document.getElementById('activeSymbols').textContent = activeSymbols;
            document.getElementById('potentialSymbols').textContent = potentialSymbols;
            document.getElementById('holdingsSymbols').textContent = holdingsSymbols;
        }
        
        // Export watchlist to CSV
        function exportWatchlist() {
            if (watchlist.length === 0) {
                alert('No symbols in watchlist to export');
                return;
            }
            
            const headers = ['Symbol', 'Category', 'Current Price', 'Change', 'Change %', 'Added Date'];
            const csvContent = [
                headers.join(','),
                ...watchlist.map(item => [
                    item.symbol,
                    item.category,
                    item.currentPrice || '',
                    item.priceChange || '',
                    item.priceChangePercent || '',
                    item.addedDate
                ].join(','))
            ].join('\n');
            
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `watchlist_${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            alert('✅ Watchlist exported successfully!');
        }
    </script>
</body>
</html> 